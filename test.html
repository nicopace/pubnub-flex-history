<html>
<head>
    <script src="//cdn.pubnub.com/pubnub-3.7.8.js"></script>
    <script src="//rawgit.com/scalabl3/pubnub-flex-history/master/pubnub-flex-history.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet">
    <script>
        var results = [];

        var p = PUBNUB.init({
            publish_key: 'demo',
            subscribe_key: 'demo'
        });

        p.flex_history = pubnub_flex_history;


        p.flex_history({
            channel: 'AAPL',
            last: 20
        }, function(result) {

            if (!result.error) {
                results.push(results);
                console.log("last 350 completed", result);
            }
            else {
                console.warn("last 350 failed", result);
            }

        });


        p.time(
                function(time){
                    //console.log(time);
                    var utcs = (time / 10000000) | 0;
                    var s = new Date(0);
                    s.setUTCSeconds(utcs);
                    //console.log(utcs);
                    //console.log(s);

                    var startTime = (utcs - (60 * 5)) * 10000000;
                    var endTime = (utcs - (60 * 1)) * 10000000;

                    setTimeout(function() {

                        p.flex_history({
                            channel: 'AAPL',
                            between: [startTime, endTime]
                        }, function(result) {

                            if (!result.error) {
                                results.push(results);
                                console.log("between 2-3 mins completed", result);
                            }
                            else {
                                console.warn("between 2-3 mins failed", result);
                            }

                        });

                    }, 2000);
                }
        );


        // Test getrange followed by at, since, and upto
        var at;

        p.flex_history({
            channel: 'AAPL',
            getrange: true
        }, function (result) {

            if (!result.error) {
                console.log("getrange completed", result);

                // calculate timetoken midway between start and end of range
                at = ((result.endE - result.startE) / 2 | 0) + result.startE;

                // test at
                p.flex_history({
                    channel: 'AAPL',
                    at: at
                }, function(result) {

                    if (!result.error) {
                        results.push(results);
                        console.log("at completed", result);
                    }
                    else {
                        console.warn("at failed", result)
                    }

                });

                // test since
                p.flex_history({
                    channel: 'AAPL',
                    since: result.endE - (60*2)
                }, function(result) {

                    if (!result.error) {
                        results.push(results);
                        console.log("since completed", result);
                    }
                    else {
                        console.warn("since failed", result);
                    }

                });

                // test upto
                p.flex_history({
                    channel: 'AAPL',
                    upto: result.startE + (60*2)
                }, function(result) {

                    if (!result.error) {
                        results.push(results);
                        console.log("upto completed", result);
                    }
                    else {
                        console.warn("upto failed", result);
                    }
                });



            }
            else {
                console.warn("between 2-3 mins failed", result);
                console.warn("not running at operation");
            }
        });



        setTimeout(function(){

            console.log("");
            console.log("ERROR Scenarios");

            // Forget to specify channel
            p.flex_history({
                last: 20
            }, function(result) {

                if (!result.error) {
                    console.log("last 20 completed", result);
                }
                else {
                    console.warn("last 20 failed", result)
                }

            });

            // Forget to specify operation
            p.flex_history({
                channel: 'AAPL'
            }, function(result) {

                if (!result.error) {
                    console.log("completed", result);
                }
                else {
                    console.warn("no operation failed", result)
                }

            });

        }, 4000);

    </script>
</head>
<body>
<h4>Open the Debug Console to see the Tests and Results</h4>
</body>
</html>